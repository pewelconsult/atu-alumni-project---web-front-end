<div class="container mx-auto px-4 py-8" *ngIf="!loading; else loadingTemplate">
  <!-- Error State -->
  <div *ngIf="error" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl mb-6">
    {{ error }}
  </div>

  <!-- Profile Content -->
  <div *ngIf="user">
    <!-- Header -->
    <div class="bg-gradient-to-r from-primary to-accent text-white rounded-2xl shadow-lg p-6 mb-8 slide-in relative overflow-hidden">
      <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-32 translate-x-32"></div>
      <div class="relative z-10">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold mb-2">
              {{ isOwnProfile ? 'My Profile' : getUserFullName() }}
            </h1>
            <p class="opacity-90">
              {{ isOwnProfile ? 'Manage your profile and connect with alumni' : 'Alumni Profile' }}
            </p>
          </div>
          <div class="mt-4 md:mt-0 flex space-x-2">
            <!-- Back Button (for other profiles) -->
            <button 
              *ngIf="!isOwnProfile"
              (click)="goBack()"
              class="bg-white/20 text-white px-4 py-2.5 rounded-xl hover:bg-white/30 transition-all duration-300 font-medium border border-white/30 flex items-center">
              <i class="fas fa-arrow-left mr-2"></i>Back
            </button>
            
            <!-- Edit Button (for own profile) -->
            <button 
              *ngIf="isOwnProfile"
              (click)="toggleEdit()" 
              class="bg-white text-primary px-6 py-3 rounded-xl hover:bg-opacity-90 transition-colors duration-300 font-medium flex items-center space-x-2">
              <i class="fas fa-edit"></i>
              <span>{{ isEditing ? 'Cancel' : 'Edit Profile' }}</span>
            </button>
            
            <!-- Connect Button (for other profiles) -->
            <button 
              *ngIf="!isOwnProfile && !isConnected && !hasPendingRequest"
              (click)="sendConnectionRequest()"
              class="bg-white text-primary px-6 py-3 rounded-xl hover:bg-opacity-90 transition-colors duration-300 font-medium flex items-center space-x-2">
              <i class="fas fa-user-plus"></i>
              <span>Connect</span>
            </button>
            
            <!-- Pending Button (for other profiles) -->
            <button 
              *ngIf="!isOwnProfile && hasPendingRequest"
              disabled
              class="bg-white/50 text-white px-6 py-3 rounded-xl font-medium flex items-center space-x-2 cursor-not-allowed">
              <i class="fas fa-clock"></i>
              <span>Pending</span>
            </button>
            
            <!-- Message Button (for connected profiles) -->
            <button 
              *ngIf="!isOwnProfile && isConnected"
              (click)="messageUser()"
              class="bg-white text-primary px-6 py-3 rounded-xl hover:bg-opacity-90 transition-colors duration-300 font-medium flex items-center space-x-2">
              <i class="fas fa-comment"></i>
              <span>Message</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Left Sidebar - Profile Info -->
      <div class="w-full lg:w-1/3 space-y-6">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="bg-gradient-to-r from-primary to-accent p-6 text-white text-center">
            <!-- Profile Picture -->
            <div class="relative inline-block mb-4">
              <div *ngIf="user.profile_picture || profilePicturePreview; else noProfilePic" 
                   class="w-24 h-24 rounded-full overflow-hidden mx-auto ring-4 ring-white">
                <img [src]="getProfilePictureUrl()" 
                     alt="Profile" 
                     class="w-full h-full object-cover">
              </div>
              <ng-template #noProfilePic>
                <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-primary font-bold text-2xl mx-auto ring-4 ring-white">
                  {{ getInitials() }}
                </div>
              </ng-template>
              
              <!-- Edit Icon (only for own profile) -->
              <button *ngIf="isOwnProfile && isEditing"
                      class="absolute bottom-0 right-0 bg-white text-primary rounded-full p-2 shadow-lg hover:bg-gray-100 transition">
                <i class="fas fa-camera text-sm"></i>
                <input type="file" 
                       accept="image/*" 
                       (change)="onProfilePictureSelected($event)"
                       class="absolute inset-0 opacity-0 cursor-pointer">
              </button>
            </div>
            
            <h2 class="text-xl font-bold">{{ user.first_name }} {{ user.last_name }}</h2>
            <p class="opacity-90">{{ user.job_title || 'Alumni' }}</p>
            <p class="text-sm opacity-80 mt-1" *ngIf="user.program_of_study && user.graduation_year">
              {{ user.program_of_study }}, {{ user.graduation_year }}
            </p>
          </div>

          <div class="p-6">
            <div class="grid grid-cols-3 gap-4 text-center mb-6">
              <div>
                <p class="font-bold text-primary text-lg">—</p>
                <p class="text-gray-500 text-sm">Connections</p>
              </div>
              <div>
                <p class="font-bold text-primary text-lg">—</p>
                <p class="text-gray-500 text-sm">Events</p>
              </div>
              <div>
                <p class="font-bold text-primary text-lg">—</p>
                <p class="text-gray-500 text-sm">Forums</p>
              </div>
            </div>

            <div class="space-y-4">
              <div class="flex items-center" *ngIf="user.current_city || user.current_country">
                <i class="fas fa-map-marker-alt text-gray-400 w-5"></i>
                <span class="ml-3 text-gray-600">
                  {{ user.current_city }}{{ user.current_city && user.current_country ? ', ' : '' }}{{ user.current_country }}
                </span>
              </div>
              <div class="flex items-center" *ngIf="user.current_company">
                <i class="fas fa-building text-gray-400 w-5"></i>
                <span class="ml-3 text-gray-600">{{ user.current_company }}</span>
              </div>
              <div class="flex items-center" *ngIf="user.show_email && user.email">
                <i class="fas fa-envelope text-gray-400 w-5"></i>
                <span class="ml-3 text-gray-600">{{ user.email }}</span>
              </div>
              <div class="flex items-center" *ngIf="user.show_phone && user.phone_number">
                <i class="fas fa-phone text-gray-400 w-5"></i>
                <span class="ml-3 text-gray-600">{{ user.phone_number }}</span>
              </div>
            </div>

            <button 
              *ngIf="isOwnProfile"
              class="w-full mt-6 bg-primary text-white py-3 rounded-xl hover:bg-opacity-90 transition-colors duration-300 font-medium">
              <i class="fas fa-share-alt mr-2"></i>
              Share Profile
            </button>

            <!-- For other profiles, show connect/message buttons -->
            <div *ngIf="!isOwnProfile" class="mt-6 space-y-2">
              <button 
                *ngIf="!isConnected && !hasPendingRequest"
                (click)="sendConnectionRequest()"
                class="w-full bg-primary text-white py-3 rounded-xl hover:bg-opacity-90 transition-colors duration-300 font-medium">
                <i class="fas fa-user-plus mr-2"></i>
                Send Connection Request
              </button>
              
              <button 
                *ngIf="hasPendingRequest"
                disabled
                class="w-full bg-gray-300 text-gray-600 py-3 rounded-xl font-medium cursor-not-allowed">
                <i class="fas fa-clock mr-2"></i>
                Request Pending
              </button>
              
              <button 
                *ngIf="isConnected"
                (click)="messageUser()"
                class="w-full bg-primary text-white py-3 rounded-xl hover:bg-opacity-90 transition-colors duration-300 font-medium">
                <i class="fas fa-comment mr-2"></i>
                Send Message
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="w-full lg:w-2/3 space-y-6">
        <!-- View Mode -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" *ngIf="!isEditing">
          <h3 class="font-bold text-xl text-gray-800 mb-4">About</h3>
          <p class="text-gray-600 mb-6" *ngIf="user.bio; else noBio">
            {{ user.bio }}
          </p>
          <ng-template #noBio>
            <p class="text-gray-400 italic">No bio added yet.</p>
          </ng-template>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Education -->
            <div>
              <h4 class="font-bold text-gray-800 mb-3">Education</h4>
              <div class="space-y-3" *ngIf="user.program_of_study || user.graduation_year; else noEdu">
                <div class="flex items-start space-x-3">
                  <div class="w-10 h-10 bg-gradient-to-r from-primary to-accent rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-graduation-cap"></i>
                  </div>
                  <div>
                    <p class="font-medium">{{ user.faculty || 'Your University' }}</p>
                    <p class="text-sm text-gray-500">
                      {{ user.program_of_study }} {{ user.major ? ', ' + user.major : '' }}
                      <span *ngIf="user.graduation_year">({{ user.graduation_year }})</span>
                    </p>
                    <p class="text-xs text-gray-400" *ngIf="user.department">{{ user.department }}</p>
                  </div>
                </div>
              </div>
              <ng-template #noEdu>
                <p class="text-gray-400 text-sm">No education info</p>
              </ng-template>
            </div>

            <!-- Experience -->
            <div>
              <h4 class="font-bold text-gray-800 mb-3">Experience</h4>
              <div class="space-y-3" *ngIf="user.current_company || user.job_title; else noExp">
                <div class="flex items-start space-x-3">
                  <div class="w-10 h-10 bg-gradient-to-r from-accent to-secondary rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-briefcase"></i>
                  </div>
                  <div>
                    <p class="font-medium">{{ user.current_company }}</p>
                    <p class="text-sm text-gray-500">
                      {{ user.job_title }} 
                      <span *ngIf="user.years_of_experience">• {{ user.years_of_experience }} yrs</span>
                    </p>
                    <p class="text-xs text-gray-400" *ngIf="user.industry">{{ user.industry }}</p>
                  </div>
                </div>
              </div>
              <ng-template #noExp>
                <p class="text-gray-400 text-sm">No experience added</p>
              </ng-template>
            </div>
          </div>

          <!-- Skills -->
          <div class="bg-gray-50 rounded-xl p-4" *ngIf="user.skills && user.skills.length > 0">
            <h4 class="font-bold text-gray-800 mb-3">Skills and Expertise</h4>
            <div class="flex flex-wrap gap-2">
              <span *ngFor="let skill of user.skills"
                    class="bg-blue-50 text-blue-700 px-3 py-2 rounded-lg text-sm border border-blue-100">
                {{ skill }}
              </span>
            </div>
          </div>
        </div>

        <!-- Edit Form -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6" *ngIf="isEditing">
          <h3 class="font-bold text-xl text-gray-800 mb-6">Edit Profile</h3>
          
          <form (ngSubmit)="saveProfile()" #profileForm="ngForm" class="space-y-6">
            <!-- Profile Picture Upload -->
            <div class="bg-gray-50 rounded-xl p-4">
              <h4 class="font-semibold text-gray-800 mb-3">Profile Picture</h4>
              <div class="flex items-center space-x-4">
                <div class="w-20 h-20 rounded-full overflow-hidden bg-gray-200 flex-shrink-0">
                  <img *ngIf="profilePicturePreview || user.profile_picture" 
                       [src]="getProfilePictureUrl()" 
                       alt="Profile" 
                       class="w-full h-full object-cover">
                  <div *ngIf="!profilePicturePreview && !user.profile_picture" 
                       class="w-full h-full flex items-center justify-center text-gray-400">
                    <i class="fas fa-user text-2xl"></i>
                  </div>
                </div>
                <div class="flex-1">
                  <input type="file" 
                         accept="image/*" 
                         (change)="onProfilePictureSelected($event)"
                         #profilePicInput
                         class="hidden">
                  <button type="button"
                          (click)="profilePicInput.click()"
                          class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition text-sm">
                    <i class="fas fa-upload mr-2"></i>Choose Image
                  </button>
                  <button *ngIf="profilePictureFile" 
                          type="button"
                          (click)="uploadProfilePicture()"
                          [disabled]="uploadingProfilePicture"
                          class="ml-2 bg-primary text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition text-sm disabled:opacity-50">
                    <i class="fas fa-check mr-2"></i>{{ uploadingProfilePicture ? 'Uploading...' : 'Upload' }}
                  </button>
                  <button *ngIf="profilePicturePreview" 
                          type="button"
                          (click)="removeProfilePicturePreview()"
                          class="ml-2 text-red-600 hover:text-red-700 text-sm">
                    <i class="fas fa-times mr-1"></i>Cancel
                  </button>
                  <p class="text-xs text-gray-500 mt-2">JPG, PNG or GIF (Max 5MB)</p>
                </div>
              </div>
            </div>

            <!-- Personal Information -->
            <div>
              <h4 class="font-semibold text-gray-800 mb-3">Personal Information</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                  <input type="text" [(ngModel)]="editForm.first_name" name="first_name"
                         placeholder="First Name" class="input-field" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                  <input type="text" [(ngModel)]="editForm.last_name" name="last_name"
                         placeholder="Last Name" class="input-field" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Other Name</label>
                  <input type="text" [(ngModel)]="editForm.other_name" name="other_name"
                         placeholder="Middle Name" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                  <input type="text" [(ngModel)]="editForm.phone_number" name="phone_number"
                         placeholder="Phone Number" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                  <input type="date" [(ngModel)]="editForm.date_of_birth" name="date_of_birth"
                         class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                  <select [(ngModel)]="editForm.gender" name="gender" class="input-field">
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                    <option value="prefer_not_to_say">Prefer not to say</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Academic Information -->
            <div>
              <h4 class="font-semibold text-gray-800 mb-3">Academic Information</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Student ID</label>
                  <input type="text" [(ngModel)]="editForm.student_id" name="student_id"
                         placeholder="Student ID" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Graduation Year</label>
                  <input type="number" [(ngModel)]="editForm.graduation_year" name="graduation_year"
                         placeholder="2020" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Program of Study</label>
                  <input type="text" [(ngModel)]="editForm.program_of_study" name="program_of_study"
                         placeholder="Computer Science" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Major</label>
                  <input type="text" [(ngModel)]="editForm.major" name="major"
                         placeholder="Software Engineering" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Faculty</label>
                  <input type="text" [(ngModel)]="editForm.faculty" name="faculty"
                         placeholder="Faculty of Computing" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                  <input type="text" [(ngModel)]="editForm.department" name="department"
                         placeholder="Computer Science Department" class="input-field">
                </div>
              </div>
            </div>

            <!-- Professional Information -->
            <div>
              <h4 class="font-semibold text-gray-800 mb-3">Professional Information</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Current Company</label>
                  <input type="text" [(ngModel)]="editForm.current_company" name="current_company"
                         placeholder="Google" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Job Title</label>
                  <input type="text" [(ngModel)]="editForm.job_title" name="job_title"
                         placeholder="Software Engineer" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                  <input type="text" [(ngModel)]="editForm.industry" name="industry"
                         placeholder="Technology" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Years of Experience</label>
                  <input type="number" [(ngModel)]="editForm.years_of_experience" name="years_of_experience"
                         placeholder="5" class="input-field">
                </div>
              </div>
            </div>

            <!-- Location -->
            <div>
              <h4 class="font-semibold text-gray-800 mb-3">Location</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Current City</label>
                  <input type="text" [(ngModel)]="editForm.current_city" name="current_city"
                         placeholder="Accra" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Current Country</label>
                  <input type="text" [(ngModel)]="editForm.current_country" name="current_country"
                         placeholder="Ghana" class="input-field">
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Hometown</label>
                  <input type="text" [(ngModel)]="editForm.hometown" name="hometown"
                         placeholder="Kumasi" class="input-field">
                </div>
              </div>
            </div>

            <!-- Bio -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
              <textarea [(ngModel)]="editForm.bio" name="bio" rows="4"
                        placeholder="Tell us about yourself..." class="input-field w-full"></textarea>
            </div>

            <!-- Social Links -->
            <div>
              <h4 class="font-semibold text-gray-800 mb-3">Social Links</h4>
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn</label>
                  <input type="url" [(ngModel)]="editForm.linkedin_url" name="linkedin_url"
                         placeholder="https://linkedin.com/in/yourprofile" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Twitter</label>
                  <input type="url" [(ngModel)]="editForm.twitter_url" name="twitter_url"
                         placeholder="https://twitter.com/yourhandle" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Facebook</label>
                  <input type="url" [(ngModel)]="editForm.facebook_url" name="facebook_url"
                         placeholder="https://facebook.com/yourprofile" class="input-field">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
                  <input type="url" [(ngModel)]="editForm.website_url" name="website_url"
                         placeholder="https://yourwebsite.com" class="input-field">
                </div>
              </div>
            </div>

            <!-- Privacy Settings -->
            <div>
              <h4 class="font-semibold text-gray-800 mb-3">Privacy Settings</h4>
              <div class="space-y-3">
                <div class="flex items-center">
                  <input type="checkbox" [(ngModel)]="editForm.show_email" name="show_email"
                         id="show_email" class="mr-3">
                  <label for="show_email" class="text-sm text-gray-700">Show email on profile</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" [(ngModel)]="editForm.show_phone" name="show_phone"
                         id="show_phone" class="mr-3">
                  <label for="show_phone" class="text-sm text-gray-700">Show phone number on profile</label>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-4 border-t">
              <button type="submit" 
                      class="bg-primary text-white px-6 py-3 rounded-xl font-medium hover:bg-opacity-90 transition">
                <i class="fas fa-save mr-2"></i>Save Changes
              </button>
              <button type="button" 
                      (click)="cancelEdit()" 
                      class="bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium hover:bg-gray-300 transition">
                <i class="fas fa-times mr-2"></i>Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Template -->
<ng-template #loadingTemplate>
  <div class="flex justify-center items-center py-20">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
  </div>
</ng-template>