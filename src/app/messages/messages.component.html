<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="bg-gradient-to-r from-primary to-accent text-white rounded-2xl shadow-lg p-6 mb-8 slide-in relative overflow-hidden">
    <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-32 translate-x-32"></div>
    <div class="relative z-10">
      <h1 class="text-3xl font-bold mb-2">Messages</h1>
      <p class="opacity-90">Connect and chat with fellow alumni</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex flex-col lg:flex-row gap-6">
    <!-- Conversations Sidebar -->
    <div class="w-full lg:w-1/3 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <!-- Search Bar -->
      <div class="p-4 border-b border-gray-100">
        <div class="relative">
          <input 
            type="text" 
            [(ngModel)]="searchQuery"
            placeholder="Search conversations..." 
            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm"
          >
          <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
        </div>
      </div>

      <!-- Conversation List -->
      <div class="overflow-y-auto overflow-x-hidden max-h-[calc(100vh-250px)]">
        <!-- Loading State -->
        <div *ngIf="isLoadingConversations" class="flex justify-center items-center py-12">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        </div>

        <!-- No Conversations -->
        <div *ngIf="!isLoadingConversations && getFilteredConversations().length === 0" class="text-center py-12 px-4">
          <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
          <p class="text-gray-500">No conversations yet</p>
          <p class="text-gray-400 text-sm mt-2">Start connecting with alumni!</p>
        </div>

        <!-- Conversations -->
        <div 
          *ngFor="let conversation of getFilteredConversations()"
          (click)="selectConversation(conversation)"
          class="flex items-center p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors duration-300 cursor-pointer"
          [class.bg-blue-50]="selectedConversation?.conversation_id === conversation.conversation_id">
          
          <div class="relative flex-shrink-0">
            <!-- User Avatar -->
            <div 
              *ngIf="conversation.other_user_picture; else conversationInitials"
              class="w-12 h-12 rounded-full overflow-hidden">
              <img [src]="conversation.other_user_picture" [alt]="conversation.other_user_name" class="w-full h-full object-cover">
            </div>
            <ng-template #conversationInitials>
              <div class="w-12 h-12 bg-gradient-to-r from-primary to-accent rounded-full flex items-center justify-center text-white font-bold">
                {{ getUserInitials(conversation.other_user_name) }}
              </div>
            </ng-template>
            
            <!-- Online Indicator -->
            <div 
              *ngIf="conversation.is_online"
              class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white">
            </div>
          </div>
          
          <div class="ml-4 flex-1 min-w-0">
            <div class="flex justify-between items-center">
              <h3 class="font-bold text-gray-800 truncate">{{ conversation.other_user_name }}</h3>
              <span class="text-xs text-gray-500 flex-shrink-0 ml-2">
                {{ formatTime(conversation.last_message_at) }}
              </span>
            </div>
            <div class="flex items-center justify-between">
              <p class="text-sm text-gray-600 truncate flex-1">
                {{ conversation.last_message_preview || 'No messages yet' }}
              </p>
              <span 
                *ngIf="conversation.unread_count > 0"
                class="ml-2 bg-primary text-white text-xs rounded-full h-5 min-w-[20px] px-1.5 flex items-center justify-center flex-shrink-0">
                {{ conversation.unread_count }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="w-full lg:w-2/3 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
      <!-- No Conversation Selected -->
      <div *ngIf="!selectedConversation" class="flex-1 flex items-center justify-center">
        <div class="text-center">
          <i class="fas fa-comments text-gray-300 text-6xl mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Select a conversation</h3>
          <p class="text-gray-500">Choose a conversation from the list to start messaging</p>
        </div>
      </div>

      <!-- Chat Content -->
      <ng-container *ngIf="selectedConversation">
        <!-- Chat Header -->
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
          <div class="flex items-center">
            <div class="relative flex-shrink-0">
              <div 
                *ngIf="selectedConversation.other_user_picture; else headerInitials"
                class="w-12 h-12 rounded-full overflow-hidden">
                <img [src]="selectedConversation.other_user_picture" [alt]="selectedConversation.other_user_name" class="w-full h-full object-cover">
              </div>
              <ng-template #headerInitials>
                <div class="w-12 h-12 bg-gradient-to-r from-primary to-accent rounded-full flex items-center justify-center text-white font-bold">
                  {{ getUserInitials(selectedConversation.other_user_name) }}
                </div>
              </ng-template>
              
              <div 
                *ngIf="selectedConversation.is_online"
                class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white">
              </div>
            </div>
            <div class="ml-4 min-w-0">
              <h3 class="font-bold text-gray-800 truncate">{{ selectedConversation.other_user_name }}</h3>
              <p class="text-sm text-gray-500">
                {{ selectedConversation.is_online ? 'Online' : 'Offline' }}
              </p>
            </div>
          </div>
          <div class="flex space-x-2 flex-shrink-0">
            <button class="w-10 h-10 rounded-full hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center">
              <i class="fas fa-phone text-gray-600"></i>
            </button>
            <button class="w-10 h-10 rounded-full hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center">
              <i class="fas fa-video text-gray-600"></i>
            </button>
            <button class="w-10 h-10 rounded-full hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center">
              <i class="fas fa-ellipsis-v text-gray-600"></i>
            </button>
          </div>
        </div>

        <!-- Messages Container -->
        <div 
          #messagesContainer
          class="flex-1 p-4 overflow-y-auto bg-gray-50 max-h-[calc(100vh-400px)]">
          
          <!-- Loading Messages -->
          <div *ngIf="isLoadingMessages" class="flex justify-center items-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
          </div>

          <!-- Messages -->
          <ng-container *ngIf="!isLoadingMessages">
            <!-- Date Separator -->
            <div class="flex justify-center my-4">
              <span class="bg-white px-3 py-1 rounded-full text-xs text-gray-500 border border-gray-200">Today</span>
            </div>

            <!-- Message List -->
            <div *ngFor="let message of messages">
              <!-- Received Message -->
              <div 
                *ngIf="!isMyMessage(message)"
                class="flex items-start space-x-3 mb-4">
                <div 
                  *ngIf="selectedConversation.other_user_picture; else messageInitials"
                  class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                  <img [src]="selectedConversation.other_user_picture" [alt]="selectedConversation.other_user_name" class="w-full h-full object-cover">
                </div>
                <ng-template #messageInitials>
                  <div class="w-8 h-8 bg-gradient-to-r from-primary to-accent rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                    {{ getUserInitials(selectedConversation.other_user_name) }}
                  </div>
                </ng-template>
                
                <div class="max-w-[70%] min-w-0">
                  <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-sm border border-gray-100">
                    <p class="text-gray-800">{{ message.message_text }}</p>
                    <span 
                      *ngIf="message.is_edited"
                      class="text-xs text-gray-400 italic">
                      (edited)
                    </span>
                  </div>
                  <span class="text-xs text-gray-500 mt-1 block">
                    {{ formatMessageTime(message.created_at) }}
                  </span>
                </div>
              </div>

              <!-- Sent Message -->
              <div 
                *ngIf="isMyMessage(message)"
                class="flex items-start space-x-3 mb-4 justify-end">
                <div class="max-w-[70%] min-w-0">
                  <div class="bg-gradient-to-r from-primary to-accent text-white rounded-2xl rounded-tr-none p-4 shadow-sm">
                    <p>{{ message.message_text }}</p>
                    <span 
                      *ngIf="message.is_edited"
                      class="text-xs opacity-75 italic">
                      (edited)
                    </span>
                  </div>
                  <div class="flex items-center justify-end mt-1 space-x-2">
                    <span class="text-xs text-gray-500">
                      {{ formatMessageTime(message.created_at) }}
                    </span>
                    <i 
                      *ngIf="message.is_read"
                      class="fas fa-check-double text-blue-500 text-xs"
                      title="Read">
                    </i>
                    <i 
                      *ngIf="!message.is_read"
                      class="fas fa-check text-gray-400 text-xs"
                      title="Sent">
                    </i>
                  </div>
                </div>
                
                <div 
                  *ngIf="currentUser?.profile_picture; else myMessageInitials"
                  class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                  <img [src]="currentUser!.profile_picture" [alt]="currentUser!.first_name" class="w-full h-full object-cover">
                </div>
                <ng-template #myMessageInitials>
                  <div class="w-8 h-8 bg-gradient-to-r from-secondary to-primary rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                    {{ getUserInitials((currentUser?.first_name || '') + ' ' + (currentUser?.last_name || '')) }}
                  </div>
                </ng-template>
              </div>
            </div>

            <!-- Typing Indicator -->
            <div *ngIf="isOtherUserTyping" class="flex items-start space-x-3 mb-4">
              <div class="w-8 h-8 bg-gradient-to-r from-primary to-accent rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                {{ getUserInitials(selectedConversation.other_user_name) }}
              </div>
              <div class="max-w-[70%] min-w-0">
                <div class="bg-white rounded-2xl rounded-tl-none p-3 shadow-sm border border-gray-100">
                  <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                  </div>
                </div>
                <span class="text-xs text-gray-500 mt-1 block">{{ otherUserTypingName }} is typing...</span>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Message Input -->
        <div class="p-4 border-t border-gray-100">
          <form (ngSubmit)="sendMessage()" class="flex items-center space-x-3">
            <button 
              type="button"
              class="w-10 h-10 rounded-full hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-paperclip text-gray-600"></i>
            </button>
            <button 
              type="button"
              class="w-10 h-10 rounded-full hover:bg-gray-100 transition-colors duration-300 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-image text-gray-600"></i>
            </button>
            <div class="flex-1 min-w-0">
              <input 
                type="text" 
                [(ngModel)]="newMessage"
                (input)="onTyping()"
                name="message"
                placeholder="Type a message..." 
                [disabled]="isSendingMessage"
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-sm disabled:bg-gray-100"
              >
            </div>
            <button 
              type="submit"
              [disabled]="isSendingMessage || !newMessage.trim()"
              class="w-10 h-10 bg-gradient-to-r from-primary to-accent text-white rounded-full hover:shadow-lg transition-all duration-300 flex items-center justify-center flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed">
              <i *ngIf="!isSendingMessage" class="fas fa-paper-plane"></i>
              <i *ngIf="isSendingMessage" class="fas fa-spinner fa-spin"></i>
            </button>
          </form>
        </div>
      </ng-container>
    </div>
  </div>
</div>